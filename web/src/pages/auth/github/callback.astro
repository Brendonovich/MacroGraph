---
export const prerender = false;

import * as jose from "jose";

import { env } from "~/env/server";

import { PARAMS, TOKEN } from "~/schemas/twitch";

const { searchParams } = Astro.url;

const params = PARAMS.parse({
	code: searchParams.get("code"),
	state: (
		await jose.jwtVerify(
			searchParams.get("state")!,
			new TextEncoder().encode(env.AUTH_SECRET)
		)
	).payload,
});

const res = await fetch(`https://github.com/login/oauth/access_token`, {
	method: "POST",
	body: new URLSearchParams({
		client_id: env.GITHUB_CLIENT_ID,
		client_secret: env.GITHUB_CLIENT_SECRET,
		code: params.code,
	}),
	headers: {
		Accept: "application/json",
	},
});

const token = TOKEN.parse(await res.json());

if (params.state.env === "desktop") {
	return Astro.redirect(
		`http://localhost:${params.state.port}?token=${Buffer.from(
			JSON.stringify(token)
		).toString("base64")}`
	);
}
---

<script define:vars={{ token, targetOrigin: params.state.targetOrigin }}>
	/** @type Window */
	const opener = window.opener;

	opener.postMessage(token, targetOrigin);

	window.close();
</script>
